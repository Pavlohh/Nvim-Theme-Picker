
#!/bin/bash

set -e

echo "Detecting OS..."

if command -v pacman &> /dev/null; then
  echo "[+] Installing dependencies in Arch based system..."
  sudo pacman -Sy --noconfirm neovim git curl unzip
elif command -v apt &> /dev/null; then
  echo "Installing dependences in Debian based system..."
  sudo apt update
  sudo apt install -y neovim git curl unzip
else
  echo "System is not supported. Install Neovim, Git and Curl manually."
  exit 1
fi

# Backup in ~/.config/nvim
backup_nvim_config() {
  local backup_dir="$HOME/.config/nvim_backup-$(date +%Y%m%d-%H%M%S)"
  echo "~/.config/nvim already exists"
  read -p "Would you want to create a backup of existing config before overwritting? (y/N): " -r respuesta
  if [[ "$respuesta" =~ ^[Ss]$ ]]; then
    echo "Creating backup in: $backup_dir"
    mv ~/.config/nvim "$backup_dir"
  else
    echo "A backup was not requested. Existing configuration will be overwritten."
    rm -rf ~/.config/nvim
  fi
}

if [ -d "$HOME/.config/nvim" ]; then
  backup_nvim_config
fi

echo "Building config structure..."
mkdir -p ~/.config/nvim/lua/plugins

echo "Cloning Lazy.nvim..."
git clone --filter=blob:none https://github.com/folke/lazy.nvim.git \
  ~/.local/share/nvim/lazy/lazy.nvim

echo "Generating init.lua..."

cat > ~/.config/nvim/init.lua <<'EOF'
vim.g.mapleader = " "

vim.opt.rtp:prepend(vim.fn.stdpath("data") .. "/lazy/lazy.nvim")
require("lazy").setup("plugins")

vim.g.colorscheme = "catppuccin"
vim.o.background = "dark"
vim.cmd.colorscheme(vim.g.colorscheme)

local themes = {
  "catppuccin",
  "gruvbox",
  "tokyonight",
  "everforest",
  "rose-pine",
}

local function apply_theme(theme)
  pcall(function()
    vim.o.background = "dark"
    vim.cmd.colorscheme(theme)
  end)
end

-- Normal picker (without preview)
local function theme_picker()
  local pickers = require("telescope.pickers")
  local finders = require("telescope.finders")
  local actions = require("telescope.actions")
  local action_state = require("telescope.actions.state")
  local conf = require("telescope.config").values

  pickers.new({}, {
    prompt_title = "Select Theme",
    finder = finders.new_table({ results = themes }),
    sorter = conf.generic_sorter({}),
    attach_mappings = function(_, _)
      actions.select_default:replace(function()
        local selection = action_state.get_selected_entry()
        apply_theme(selection[1])
        vim.g.colorscheme = selection[1]
      end)
      return true
    end,
  }):find()
end

-- Picker with hover preview
local function theme_preview()
  local pickers = require("telescope.pickers")
  local finders = require("telescope.finders")
  local actions = require("telescope.actions")
  local action_state = require("telescope.actions.state")
  local conf = require("telescope.config").values

  local current_theme = vim.g.colorscheme or "default"
  local last_previewed = current_theme

  pickers.new({}, {
    prompt_title = "Preview Theme",
    finder = finders.new_table({ results = themes }),
    sorter = conf.generic_sorter({}),
    previewer = false, -- desactivar preview real
    attach_mappings = function(_, map)
      actions.select_default:replace(function()
        local selection = action_state.get_selected_entry()
        apply_theme(selection[1])
        vim.g.colorscheme = selection[1]
      end)

      map("i", "<esc>", function()
        apply_theme(current_theme)
        vim.cmd.stopinsert()
      end)
      map("n", "<esc>", function()
        apply_theme(current_theme)
      end)

      return true
    end,

    on_input_filter_cb = function(prompt)
      local entry = prompt and prompt:lower()
      for _, theme in ipairs(themes) do
        if entry == theme:sub(1, #entry) and theme ~= last_previewed then
          last_previewed = theme
          apply_theme(theme)
          break
        end
      end
      return prompt
    end,
  }):find()
end

vim.api.nvim_create_user_command("ThemePicker", theme_picker, {})
vim.api.nvim_create_user_command("ThemePreview", theme_preview, {})

vim.keymap.set("n", "<leader>ut", ":ThemePicker<CR>", { desc = "Cambiar tema sin preview" })
vim.keymap.set("n", "<leader>up", ":ThemePreview<CR>", { desc = "Previsualizar temas en vivo" })
EOF

echo "[+] Generando plugins/colors.lua..."

cat > ~/.config/nvim/lua/plugins/colors.lua <<'EOF'
return {
  {
    "catppuccin/nvim",
    name = "catppuccin",
    priority = 1000,
    lazy = false,
    config = function()
      require("catppuccin").setup({
        flavour = "mocha",
        transparent_background = true,
        integrations = {
          cmp = true,
          gitsigns = true,
          nvimtree = true,
          telescope = true,
          treesitter = true,
        },
      })
    end,
  },

  {
    "morhetz/gruvbox",
    priority = 1000,
    lazy = false,
  },

  {
    "folke/tokyonight.nvim",
    priority = 1000,
    lazy = false,
  },

  {
    "sainnhe/everforest",
    priority = 1000,
    lazy = false,
  },

  {
    "rose-pine/neovim",
    name = "rose-pine",
    priority = 1000,
    lazy = false,
    config = function()
      require("rose-pine").setup({
        disable_background = true,
      })
    end,
  },

  {
    "nvim-telescope/telescope.nvim",
    dependencies = { "nvim-lua/plenary.nvim" },
  },
}
EOF

echo "[âœ…] InstalaciÃ³n completed."
echo "[ðŸš€] Open Neovim and run :Lazy sync to install all plugins."
echo "[ðŸŽ¨] Usa :ThemePicker to change theme or :ThemePreview to preview themes."
